# Module Integration Contracts (v1.0.0)

## External Modules (Hard deps)

### 1. `portable-pty` — PTY lifecycle
- Назначение: spawn shell, pty IO, resize, process kill/wait.
- Внешний API используется через адаптер в `foundation/pty`.
- Контракт:
  - `openpty(size) -> (master, slave)`
  - `slave.spawn_command(CommandBuilder)`
  - `master.try_clone_reader()` + `master.take_writer()`
  - `master.resize(PtySize)`
  - `Child::try_wait / wait / kill`
- Риск:
  - EIO/EOF, зависание процесса при kill.
- Контроль:
  - `SessionController` с bounded retry.
  - timeout на read-write pump.

### 2. `winit` — window/event loop
- Назначение: создание окна, цикл событий, клавиатура/мышь, resize, redraw.
- Контракт:
  - window create only through active event loop;
  - обработка `WindowEvent::{CloseRequested, Resized, RedrawRequested, KeyboardInput, CursorMoved, MouseWheel, Focused}`.
  - обработка modifier keys и control flow.
- Риск:
  - разный lifecycle между Linux/Windows/macOS, дрейф DPI.
- Контроль:
  - отдельный слой `foundation/window` с единым event translation.

### 3. `wgpu` — GPU backend
- Назначение: accelerated render path.
- Контракт:
  - запрос устройства/очереди;
  - surface config, swap chain lifecycle;
  - submit/render pass + error handling hooks.
- Риск:
  - потеря устройства, ошибки поверхности, submit error.
- Контроль:
  - `wgpu::Device::on_uncaptured_error`, device lost callback, fallback pipeline.

### 4. Structured diagnostics stack (`tracing`, `tracing-subscriber`)
- Назначение: наблюдаемость GPU/PTY/UI событий, event-id, время отклика.
- Контракт:
  - span/event для: spawn, resize, input, render transition, fallback.
- Риск:
  - шумные логи/рост CPU.
- Контроль:
  - уровни INFO/DEBUG и sample rate для стабильности.

### 5. CLI/runtime (`clap`, `serde`, `dirs`, `thiserror`)
- Назначение: параметры запуска + типизированные настройки.
- Контракт:
  - `--mode`, `--shell`, `--no-gpu`, `--trace`, profile paths.
- Риск:
  - invalid argument state.
- Контроль:
  - schema validation at parse time + deterministic fallback to defaults.

### 6. UX/interop (`arboard`)
- Назначение: copy/paste на уровне OS.
- Контракт:
  - отдельный feature в `services/io`.
- Риск:
  - потеря clipboard contents при crash loop.
- Контроль:
  - retry + bounded user notifications.

## Internal/External Boundary
- Ни один external crate не знает внутренний формат `GridState` или event bus.
- Внешний код входит только через строго типизированные adapters and traits.

## Decision: Что НЕ подключаем в v1.0
- Multiplexer engine.
- Легаси full lua-плагинная модель.
- Сложные рендер-эффекты (blur/shadow) и расширенная графика.
- Необязательные Windows-only расширения.
